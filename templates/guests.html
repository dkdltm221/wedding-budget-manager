{% extends 'base.html' %}

{% block content %}
{% set total_guest_amount = groom_total + bride_total %}

<div class="guest-hero mb-4">
    <div class="row align-items-center">
        <div class="col-lg-8">
            <p class="hero-kicker text-uppercase mb-2">축의금 관리</p>
            <h1 class="hero-title mb-2">축의금 명부 &amp; 현황</h1>
            <p class="hero-subtext mb-3">
                신랑/신부 측 축의금을 한눈에 보고, 검색·정렬·수정·삭제를 빠르게 처리하세요.
            </p>
            <div class="d-flex flex-wrap gap-2">
                <a href="{{ url_for('guests.export_excel') }}" class="btn btn-light text-primary-emphasis shadow-sm">
                    <i class="bi bi-download me-1"></i>엑셀 다운로드
                </a>
                <a href="{{ url_for('guests.export_pdf') }}" class="btn btn-outline-light text-white shadow-sm border-white">
                    <i class="bi bi-filetype-pdf me-1"></i>PDF 출력
                </a>
            </div>
        </div>
        <div class="col-lg-4 mt-3 mt-lg-0">
            <div class="guest-hero-card">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <div class="text-light small opacity-75">총 축의금</div>
                        <div class="h3 mb-0 text-white">{{ "{:,}".format(total_guest_amount) }}<span class="guest-unit">원</span></div>
                    </div>
                    <span class="guest-chip guest-chip-light">실시간</span>
                </div>
                <div class="d-flex gap-3">
                    <div class="guest-mini-stat">
                        <div class="mini-label">신랑 측</div>
                        <div class="mini-value">{{ "{:,}".format(groom_total) }}<span class="guest-unit">원</span></div>
                    </div>
                    <div class="guest-mini-stat">
                        <div class="mini-label">신부 측</div>
                        <div class="mini-value">{{ "{:,}".format(bride_total) }}<span class="guest-unit">원</span></div>
                    </div>
                </div>
                {% if total_guest_amount > 0 %}
                {% set groom_ratio = (groom_total / total_guest_amount * 100) if total_guest_amount else 50 %}
                {% set bride_ratio = 100 - groom_ratio %}
                <div class="progress guest-progress mt-3"
                     id="guestRatioProgress"
                     data-groom="{{ groom_ratio|default(0)|round(1) }}"
                     data-bride="{{ bride_ratio|default(0)|round(1) }}">
                    <div class="progress-bar bg-guest-indigo" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
                    <div class="progress-bar bg-guest-pink" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="d-flex justify-content-between small text-light mt-1">
                    <span>신랑 측 {{ groom_ratio|round(1) }}%</span>
                    <span>신부 측 {{ bride_ratio|round(1) }}%</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="guest-stat-card">
            <div class="guest-stat-label">총 축의금</div>
            <div class="guest-stat-value">{{ "{:,}".format(total_guest_amount) }}<span class="guest-unit">원</span></div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="guest-stat-card">
            <div class="guest-stat-label">신랑 측 총액</div>
            <div class="guest-stat-value">{{ "{:,}".format(groom_total) }}<span class="guest-unit">원</span></div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="guest-stat-card">
            <div class="guest-stat-label">신부 측 총액</div>
            <div class="guest-stat-value">{{ "{:,}".format(bride_total) }}<span class="guest-unit">원</span></div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4 align-items-stretch">
    <div class="col-lg-6">
        <div class="guest-card h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <div class="text-muted small">측의금 명부</div>
                    <h5 class="mb-0">축의금 입력</h5>
                </div>
                <span class="guest-chip guest-chip-soft">빠르게 입력</span>
            </div>
            <form method="post" class="guest-form-grid">
                <div>
                    <label class="form-label">이름</label>
                    <input type="text" name="name" class="form-control" placeholder="이름" required>
                </div>
                <div>
                    <label class="form-label">측</label>
                    <select name="side" class="form-select" required>
                        <option value="">측 선택...</option>
                        <option value="groom">신랑 측</option>
                        <option value="bride">신부 측</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">금액 (원)</label>
                    <input type="number" name="amount" class="form-control" min="0" placeholder="0" required>
                </div>
                <div>
                    <label class="form-label">메모</label>
                    <input type="text" name="note" class="form-control" placeholder="메모 (선택)">
                </div>
                <div class="guest-form-actions">
                    <button type="submit" class="btn btn-primary shadow-sm px-4">
                        <i class="bi bi-plus-lg me-1"></i>추가
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="guest-card guest-card-compact h-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <div class="text-muted small">검색/정렬</div>
                    <h5 class="mb-0">이름 검색</h5>
                </div>
                <span class="guest-chip guest-chip-outline"> 검색</span>
            </div>
            <form method="get" class="row g-2 align-items-center guest-search-form">
                <div class="col-12">
                    <input type="text" name="search_name" class="form-control form-control-lg"
                           placeholder="이름 검색" value="{{ search_name }}">
                    <input type="hidden" name="sort_by" value="{{ sort_by }}">
                    <input type="hidden" name="order" value="{{ order }}">
                </div>
                <div class="col-12 d-flex justify-content-end gap-2 guest-search-actions">
                    <button class="btn btn-outline-primary" type="submit">
                        <i class="bi bi-search me-1"></i>검색
                    </button>
                </div>
            </form>
            <div class="recent-search mt-2">
                <div class="recent-title">최근 검색 결과</div>
                {% if search_results %}
                    <ul class="recent-search-list">
                        {% for guest in search_results[:5] %}
                            <li class="recent-item">
                                <div class="recent-name">{{ guest.name }}</div>
                                <div class="recent-meta">
                                    <span class="recent-amount">{{ "{:,}".format(guest.amount) }}원</span>
                                    <span class="recent-side {% if guest.side == 'groom' %}groom{% else %}bride{% endif %}">
                                        {{ '신랑 측' if guest.side == 'groom' else '신부 측' }}
                                    </span>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="text-muted small">검색하면 최근 결과가 여기 표시됩니다.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<div class="row g-3">
    <div class="col-lg-6">
        <div class="guest-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">신랑 측 목록 <span class="text-muted small">(총 {{ "{:,}".format(groom_total) }} 원)</span></h5>
                
            </div>
            <div class="table-responsive">
                <table class="table guest-table align-middle mb-0">
                    <thead>
                        <tr>
                            <th class="text-center" style="width: 60px;">#</th>
                            <th>
                                이름
                                <span class="sort-toggle">
                                    <a href="{{ url_for('guests.list_guests', search_name=search_name, sort_by='name', order='asc') }}"
                                       class="{% if sort_by == 'name' and order == 'asc' %}active{% endif %}">&#9650;</a>
                                    <a href="{{ url_for('guests.list_guests', search_name=search_name, sort_by='name', order='desc') }}"
                                       class="{% if sort_by == 'name' and order == 'desc' %}active{% endif %}">&#9660;</a>
                                </span>
                            </th>
                            <th>
                                금액(원)
                                <span class="sort-toggle">
                                    <a href="{{ url_for('guests.list_guests', search_name=search_name, sort_by='amount', order='asc') }}"
                                       class="{% if sort_by == 'amount' and order == 'asc' %}active{% endif %}">&#9650;</a>
                                    <a href="{{ url_for('guests.list_guests', search_name=search_name, sort_by='amount', order='desc') }}"
                                       class="{% if sort_by == 'amount' and order == 'desc' %}active{% endif %}">&#9660;</a>
                                </span>
                            </th>
                            <th>메모</th>
                            <th class="text-end">관리</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for guest in groom_guests %}
                            <tr>
                                <td class="text-center">{{ loop.index }}</td>
                                <td>
                                    <div class="fw-semibold">{{ guest.name }}</div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="fw-semibold">{{ "{:,}".format(guest.amount) }}</span>
                                        {% if guest.amount >= highlight_threshold %}
                                            <span class="badge badge-soft-warning">고액</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="text-muted">{{ guest.note }}</td>
                                <td class="text-end">
                                    <button type="button"
                                            class="btn btn-sm btn-outline-primary"
                                            data-edit
                                            data-id="{{ guest.id }}"
                                            data-name="{{ guest.name|e }}"
                                            data-side="{{ guest.side }}"
                                            data-amount="{{ guest.amount }}"
                                            data-note="{{ guest.note|default('', true)|e }}"
                                            data-edit-url="{{ url_for('guests.edit_guest', guest_id=guest.id) }}"
                                            data-delete-url="{{ url_for('guests.delete_guest', guest_id=guest.id) }}">
                                        수정
                                    </button>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">등록된 신랑 측 축의금이 없습니다.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="guest-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">신부 측 목록 <span class="text-muted small">(총 {{ "{:,}".format(bride_total) }} 원)</span></h5>
            </div>
            <div class="table-responsive">
                <table class="table guest-table align-middle mb-0">
                    <thead>
                        <tr>
                            <th class="text-center" style="width: 60px;">#</th>
                            <th>
                                이름
                                <span class="sort-toggle">
                                    <a href="{{ url_for('guests.list_guests', search_name=search_name, sort_by='name', order='asc') }}"
                                       class="{% if sort_by == 'name' and order == 'asc' %}active{% endif %}">&#9650;</a>
                                    <a href="{{ url_for('guests.list_guests', search_name=search_name, sort_by='name', order='desc') }}"
                                       class="{% if sort_by == 'name' and order == 'desc' %}active{% endif %}">&#9660;</a>
                                </span>
                            </th>
                            <th>
                                금액(원)
                                <span class="sort-toggle">
                                    <a href="{{ url_for('guests.list_guests', search_name=search_name, sort_by='amount', order='asc') }}"
                                       class="{% if sort_by == 'amount' and order == 'asc' %}active{% endif %}">&#9650;</a>
                                    <a href="{{ url_for('guests.list_guests', search_name=search_name, sort_by='amount', order='desc') }}"
                                       class="{% if sort_by == 'amount' and order == 'desc' %}active{% endif %}">&#9660;</a>
                                </span>
                            </th>
                            <th>메모</th>
                            <th class="text-end">관리</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for guest in bride_guests %}
                            <tr>
                                <td class="text-center">{{ loop.index }}</td>
                                <td><div class="fw-semibold">{{ guest.name }}</div></td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="fw-semibold">{{ "{:,}".format(guest.amount) }}</span>
                                        {% if guest.amount >= highlight_threshold %}
                                            <span class="badge badge-soft-warning">고액</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="text-muted">{{ guest.note }}</td>
                                <td class="text-end">
                                    <button type="button"
                                            class="btn btn-sm btn-outline-primary"
                                            data-edit
                                            data-id="{{ guest.id }}"
                                            data-name="{{ guest.name|e }}"
                                            data-side="{{ guest.side }}"
                                            data-amount="{{ guest.amount }}"
                                            data-note="{{ guest.note|default('', true)|e }}"
                                            data-edit-url="{{ url_for('guests.edit_guest', guest_id=guest.id) }}"
                                            data-delete-url="{{ url_for('guests.delete_guest', guest_id=guest.id) }}">
                                        수정
                                    </button>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">등록된 신부 측 축의금이 없습니다.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{# 검색 결과 모달 #}
<div class="modal fade" id="searchModal" tabindex="-1" aria-hidden="true"
     data-autoshow="{{ 'true' if search_name else 'false' }}">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">검색 결과: "{{ search_name }}"</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if search_results %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>이름</th>
                                    <th>금액(원)</th>
                                    <th>측</th>
                                    <th>메모</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for guest in search_results %}
                                    <tr>
                                        <td>{{ guest.name }}</td>
                                        <td>{{ "{:,}".format(guest.amount) }}</td>
                                        <td>{{ '신랑 측' if guest.side == 'groom' else '신부 측' }}</td>
                                        <td>{{ guest.note }}</td>
                                        <td>
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-primary"
                                                    data-edit-from-search
                                                    data-id="{{ guest.id }}"
                                                    data-name="{{ guest.name|e }}"
                                                    data-side="{{ guest.side }}"
                                                    data-amount="{{ guest.amount }}"
                                                    data-note="{{ guest.note|default('', true)|e }}"
                                                    data-edit-url="{{ url_for('guests.edit_guest', guest_id=guest.id) }}"
                                                    data-delete-url="{{ url_for('guests.delete_guest', guest_id=guest.id) }}">
                                                수정
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="mb-0 text-muted">검색 결과가 없습니다.</p>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

{# 수정/삭제 모달 #}
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">축의금 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editForm" method="post">
                    <div class="mb-3">
                        <label class="form-label">이름</label>
                        <input type="text" class="form-control" id="editName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">측</label>
                        <select class="form-select" id="editSide" name="side" required>
                            <option value="groom">신랑 측</option>
                            <option value="bride">신부 측</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">금액(원)</label>
                        <input type="number" class="form-control" id="editAmount" name="amount" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">메모</label>
                        <textarea class="form-control" id="editNote" name="note" rows="3"></textarea>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-danger" id="deleteButton">삭제</button>
                        <button type="submit" class="btn btn-primary">저장</button>
                    </div>
                </form>
                <form id="deleteForm" method="post" class="d-none"></form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const editModalEl = document.getElementById('editModal');
    const editModal = new bootstrap.Modal(editModalEl);
    const searchModalEl = document.getElementById('searchModal');
    const searchModal = searchModalEl ? new bootstrap.Modal(searchModalEl) : null;

    const editForm = document.getElementById('editForm');
    const deleteForm = document.getElementById('deleteForm');

    function openEditModal(data) {
        editForm.action = data.editUrl;
        deleteForm.action = data.deleteUrl;

        document.getElementById('editName').value = data.name || '';
        document.getElementById('editSide').value = data.side || 'groom';
        document.getElementById('editAmount').value = data.amount || 0;
        document.getElementById('editNote').value = data.note || '';

        if (searchModal) {
            searchModal.hide();
        }
        editModal.show();
    }

    document.querySelectorAll('[data-edit]').forEach(function (btn) {
        btn.addEventListener('click', function () {
            openEditModal({
                id: btn.dataset.id,
                name: btn.dataset.name,
                side: btn.dataset.side,
                amount: btn.dataset.amount,
                note: btn.dataset.note,
                editUrl: btn.dataset.editUrl,
                deleteUrl: btn.dataset.deleteUrl
            });
        });
    });

    document.querySelectorAll('[data-edit-from-search]').forEach(function (btn) {
        btn.addEventListener('click', function () {
            openEditModal({
                id: btn.dataset.id,
                name: btn.dataset.name,
                side: btn.dataset.side,
                amount: btn.dataset.amount,
                note: btn.dataset.note,
                editUrl: btn.dataset.editUrl,
                deleteUrl: btn.dataset.deleteUrl
            });
        });
    });

    const deleteButton = document.getElementById('deleteButton');
    deleteButton.addEventListener('click', function () {
        if (confirm('정말 삭제할까요?')) {
            deleteForm.submit();
        }
    });

    if (searchModalEl && searchModalEl.dataset.autoshow === 'true') {
        searchModal.show();
    }

    // 비율 진행바 너비 설정 (템플릿 경고 방지용 데이터-속성 사용)
    const ratioEl = document.getElementById('guestRatioProgress');
    if (ratioEl) {
        const groomPct = Number(ratioEl.dataset.groom || 0);
        const bridePct = Number(ratioEl.dataset.bride || 0);
        const bars = ratioEl.querySelectorAll('.progress-bar');
        if (bars[0]) {
            bars[0].style.width = `${groomPct}%`;
            bars[0].setAttribute('aria-valuenow', groomPct);
        }
        if (bars[1]) {
            bars[1].style.width = `${bridePct}%`;
            bars[1].setAttribute('aria-valuenow', bridePct);
        }
    }
});
</script>
{% endblock %}
